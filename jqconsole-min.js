(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=function(a,b){return function(){return a.apply(b,arguments)}};a=jQuery,m=0,n=1,g=13,k=9,d=46,c=8,i=37,j=39,l=38,e=40,h=36,f=35,b=function(){function b(b,c){this.header=c!=null?c:"",this.state=n,this.saved_lines=[],this.enter_callback=null,this.multiline_callback=null,this.history=[],this.history_index=0,this.history_new="",this.history_active=!1,this.shortcuts={},this.$console=a('<pre class="jqconsole"/>').appendTo(b),this.$prompt=a('<span class="jqconsole-input"/>'),this.$prompt_left=a("<span/>").appendTo(this.$prompt),this.$prompt_left.css({position:"relative"}),this.$prompt_right=a("<span/>").appendTo(this.$prompt),this.$prompt_right.css({position:"relative"}),this.$prompt_cursor=a('<span class="jqconsole-cursor"> </span>'),this.$prompt_cursor.insertBefore(this.$prompt_right),this.$prompt_cursor.css({color:"transparent",display:"inline",position:"absolute",zIndex:0}),this.$input_source=a("<textarea/>"),this.$input_source.css({position:"absolute",left:"-9999px"}),this.$input_source.appendTo(b),this.SetupEvents(),this.Write(this.header,"jqconsole-header"),a(b).data("jqconsole",this)}b.prototype.Reset=function(){this.history=[],this.history_index=0,this.history_current="",this.state=n,this.shortcuts={},this.$prompt_left.text(""),this.$prompt_right.text(""),this.$prompt.parent()&&this.$prompt.detach(),this.$console.html("");return this.Write(this.header,"jqconsole-header")},b.prototype.RegisterShortcut=function(a,b){a=parseInt(a,10);if(isNaN(a)||!0<a&&a<256)throw new Error("Key code must be a number between 0 and 256 exclusive.");if(!b instanceof Function)throw new Error("Callback must be a function, not "+b+".");this.shortcuts[a]==null&&(this.shortcuts[a]=[]);return this.shortcuts[a].push(b)},b.prototype.Write=function(b,c){var d;if(this.state!==n)throw new Error("Write() is only allowed in output state.");d=a("<span>"),d.text(b),c!=null&&d.addClass(c),d.appendTo(this.$console);return this.ScrollToEnd()},b.prototype.GetPromptText=function(){if(this.state!==m)throw new Error("GetPromptText() is only allowed in input state.");return this.$prompt_left.text()+this.$prompt_right.text()},b.prototype.SetPromptText=function(a){if(this.state!==m)throw new Error("SetPromptText() is only allowed in input state.");this.$prompt_left.text(a),this.$prompt_right.text("");return this.ScrollToEnd()},b.prototype.Input=function(a,b,c){if(this.state!==n)throw new Error("Input() is only allowed in output state.");this.history_active=a,this.enter_callback=b,this.multiline_callback=c,this.$prompt.appendTo(this.$console),this.Focus(),this.ScrollToEnd();return this.state=m},b.prototype.Focus=function(){return this.$input_source.focus()},b.prototype.SetupEvents=function(){var b;this.$console.mouseup(o(function(){return this.Focus()},this)),this.$input_source.bind("paste",o(function(){var a;a=o(function(){this.$prompt_left.text(this.$prompt_left.text()+this.$input_source.val()),this.$input_source.val("");return this.$input_source.focus()},this);return setTimeout(a,0)},this)),this.$input_source.keypress(o(function(a){return this.HandleChar(a)},this)),b=a.browser.mozilla?"keypress":"keydown";return this.$input_source[b](o(function(a){return this.HandleKey(a)},this))},b.prototype.ScrollToEnd=function(){return this.$console.scrollTop(this.$console[0].scrollHeight)},b.prototype.HandleChar=function(b){var c;if(this.state===n)return!0;if(a.browser.mozilla&&!b.charCode)return!0;if(a.browser.opera&&!b.which)return!0;c=b.which;if(c===13||c===9)return!1;if(b.metaKey||b.ctrlKey||b.altKey)return!1;this.$prompt_left.text(this.$prompt_left.text()+String.fromCharCode(c)),this.ScrollToEnd();return!1},b.prototype.HandleKey=function(a){var b;if(this.state===n)return!0;if(a.altKey||a.shiftKey||a.metaKey&&!a.ctrlKey)return!0;if(a.ctrlKey)return this.HandleCtrlShortcut(a.keyCode);b=a.keyCode;switch(b){case g:this.HandleEnter(a.shiftKey);break;case k:this.InsertTab();break;case d:this.Delete(!1);break;case c:this.Backspace(!1);break;case i:this.MoveLeft(!1);break;case j:this.MoveRight(!1);break;case l:this.HistoryPrevious();break;case e:this.HistoryNext();break;case h:this.MoveToStart();break;case f:this.MoveToEnd();break;default:return!0}return!1},b.prototype.HandleCtrlShortcut=function(a){var b,e,f,g;switch(a){case d:this.Delete(!0);break;case c:this.Backspace(!0);break;case i:this.MoveLeft(!0);break;case j:this.MoveRight(!0);break;default:if(this.shortcuts[a]!=null){g=this.shortcuts[a];for(e=0,f=g.length;e<f;e++)b=g[e],b.call(this);return!1}return!0}return!1},b.prototype.MoveLeft=function(a){var b,c;b=this.$prompt_left.text();if(!!b){if(a){c=b.match(/\w*\W*$/);if(!c)return;c=c[0],this.$prompt_right.text(c+this.$prompt_right.text());return this.$prompt_left.text(b.slice(0,-c.length))}this.$prompt_right.text(b.slice(-1)+this.$prompt_right.text());return this.$prompt_left.text(b.slice(0,-1))}},b.prototype.MoveRight=function(a){var b,c;b=this.$prompt_right.text();if(!!b){if(a){c=b.match(/^\w*\W*/);if(!c)return;c=c[0],this.$prompt_left.text(this.$prompt_left.text()+c);return this.$prompt_right.text(b.slice(c.length))}this.$prompt_left.text(this.$prompt_left.text()+b[0]);return this.$prompt_right.text(b.slice(1))}},b.prototype.Delete=function(a){var b,c;b=this.$prompt_right.text();if(!!b){if(a){c=b.match(/^\w*\W*/);if(!c)return;c=c[0];return this.$prompt_right.text(b.slice(c.length))}return this.$prompt_right.text(b.slice(1))}},b.prototype.Backspace=function(a){var b,c;b=this.$prompt_left.text();if(!!b){if(a){c=b.match(/\w*\W*$/);if(!c)return;c=c[0];return this.$prompt_left.text(b.slice(0,-c.length))}return this.$prompt_left.text(b.slice(0,-1))}},b.prototype.InsertTab=function(){return this.$prompt_left.append("  ")},b.prototype.MoveToStart=function(){this.$prompt_right.text(this.$prompt_left.text()+this.$prompt_right.text());return this.$prompt_left.text("")},b.prototype.MoveToEnd=function(){this.$prompt_left.text(this.$prompt_left.text()+this.$prompt_right.text());return this.$prompt_right.text("")},b.prototype.HistoryPrevious=function(){if(!!this.history_active){if(this.history_index<=0)return;this.history_index===this.history.length&&(this.history_new=this.GetPromptText());return this.SetPromptText(this.history[--this.history_index])}},b.prototype.HistoryNext=function(){if(!!this.history_active){if(this.history_index>=this.history.length)return;if(this.history_index===this.history.length-1){this.history_index++;return this.SetPromptText(this.history_new)}return this.SetPromptText(this.history[++this.history_index])}},b.prototype.HandleEnter=function(a){var b,c;if(!a){this.saved_lines.push(this.GetPromptText()),this.SetPromptText(""),c=this.saved_lines.join("\n");if(!this.multiline_callback||!this.multiline_callback(c)){this.history_active&&(!this.history.length||this.history[this.history.length-1]!==c)&&(this.history.push(c),this.history_index=this.history.length),this.saved_lines=[],this.$prompt.detach(),this.state=n,this.Write(c+"\n"),b=this.enter_callback,this.enter_callback=null;return b(c)}}};return b}(),a.fn.jqconsole=function(a){return new b(this,a)}}).call(this)